# Amoiq Chat Widget

Public-facing chat widget for customer websites.

## Installation

Customers install with one script:

```html
<script>
  window.ChatWidgetConfig = {
    tenantId: "xxx",
    position: "bottom-right"
  };
</script>
<script src="https://webchat.amoiq.com/widget.v1.0.0.js" async></script>
```

## Development

```bash
npm install
npm run dev
```

The widget will be available at `http://localhost:3000`. Test the embed page at `http://localhost:3000/embed?tenantId=test`.

## Environment Variables

Create a `.env.local` file:

```env
NEXT_PUBLIC_GATEWAY_URL=https://api-gateway.amoiq.com
NEXT_PUBLIC_GATEWAY_API_KEY=your-jwt-token-optional
```

**Important:**
- **`NEXT_PUBLIC_GATEWAY_URL`** (Required): Gateway URL - all connections (HTTP and WebSocket) go through gateway
- **`NEXT_PUBLIC_GATEWAY_API_KEY`** (Optional): JWT token for authenticated users
  - For anonymous users: token is obtained from gateway endpoint `POST /api/chat/anonymous-token`
  - For admin users: token is obtained from your authentication system
- **Deprecated variables:**
  - `NEXT_PUBLIC_API_URL` - Use `NEXT_PUBLIC_GATEWAY_URL` instead
  - `NEXT_PUBLIC_WS_URL` - Use `NEXT_PUBLIC_GATEWAY_URL` instead (gateway handles WebSocket)
  - `NEXT_PUBLIC_WEBSOCKET_URL` - Use `NEXT_PUBLIC_GATEWAY_URL` instead

## Deployment

Deployed to Vercel at `webchat.amoiq.com`.

### Vercel Configuration

- Project name: `amoiq-chat-widget`
- Domain: `webchat.amoiq.com`
- Framework: Next.js
- Build command: `npm run build`
- Output directory: `.next`

The `vercel.json` file configures caching headers automatically.

## Features

- ✅ **Production-ready session management** - Tracks users across tabs and browser restarts
- ✅ **Browser fingerprinting** - Identifies same user across devices
- ✅ **Anonymous & logged-in users** - Single endpoint handles both user types
- ✅ **Conversation history** - Automatically loads previous conversations
- ✅ **Real-time messaging** - WebSocket with HTTP API fallback
- ✅ **Retry logic** - Automatic retries with exponential backoff
- ✅ **Error handling** - Graceful degradation and user feedback

## Architecture

- **widget.v1.0.0.js**: Static loader script (CDN cached forever)
  - Injects iframe pointing to `/embed`
  - Handles floating bubble UI
  - Reads `window.ChatWidgetConfig`
  - No React, pure vanilla JS

- **/embed**: React chat UI (no cache, runs in iframe)
  - Full chat interface
  - Connects to backend API + WebSocket via Gateway
  - Session management (localStorage, fingerprinting)
  - Conversation history loading
  - Tenant-scoped via URL params
  - `force-dynamic` rendering

- **lib/session.ts**: Session management utility
  - Generates and persists sessionId (localStorage)
  - Browser fingerprinting for user identification
  - Session expiration (24 hours)
  - Cross-tab session sharing

## Project Structure

```
amoiq-chat-widget/
├── app/
│   ├── embed/
│   │   ├── page.tsx          # Chat UI component
│   │   └── styles.module.css # Chat styles
│   ├── layout.tsx             # Root layout
│   ├── page.tsx               # Home page
│   └── globals.css            # Global styles
├── lib/
│   ├── api.ts                 # Backend API client (with session management)
│   ├── ws.ts                  # WebSocket client (with session management)
│   ├── session.ts             # Session management utility
│   └── tenant.ts              # Tenant resolution
├── public/
│   └── widget.v1.0.0.js       # Widget loader script
├── next.config.js             # Next.js config with caching
└── vercel.json                # Vercel deployment config
```

## Documentation

Complete documentation is available in the [`docs/`](./docs/) folder:

- **[Getting Started](./docs/01-getting-started.md)** - Quick installation and setup
- **[Backend Setup](./docs/02-backend-setup.md)** - Backend services setup guide
- **[Session Management](./docs/03-session-management.md)** - Session handling and user identification
- **[Admin Integration](./docs/04-admin-integration.md)** - Admin online users integration
- **[Embedding Guide](./docs/05-embedding.md)** - How to embed the widget
- **[API Reference](./docs/06-api-reference.md)** - Complete API documentation

**Quick Start:** See [docs/README.md](./docs/README.md) for the full documentation index.

## Session Management

The widget includes production-ready session management:

- **Session persistence**: 24-hour expiration, shared across tabs (localStorage)
- **Browser fingerprinting**: Identifies same user across devices/sessions
- **Conversation continuity**: Automatically loads history when user returns
- **Anonymous & logged-in**: Single endpoint `POST /webchat/message` handles both user types
- **Backend determines user type**: Based on `userId` presence in payload

See [SESSION_MANAGEMENT.md](./SESSION_MANAGEMENT.md) for complete details.

## Security

- API key authentication at Gateway (Bearer token)
- JWT tokens generated by Backend (server-side only, has `JWT_SECRET`)
- Session management with 24-hour expiration
- Tenant-scoped requests
- Domain allowlist (optional, configure in backend)

